<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Settings</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .container {
            background-color: #f0f2f5;
            width: 100%;
            max-width: 400px;
            padding: 20px;
            box-sizing: border-box;
        }

        .header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .back-arrow {
            font-size: 24px;
            text-decoration: none;
            color: #000;
            margin-right: 15px;
        }

        h1 {
            font-size: 20px;
            margin: 0;
        }

        .profile-card {
            background-color: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
        }

        .profile-picture {
            width: 300px;
            height: 300px;
            border-radius: 50%;
            border: 3px solid #4CAF50;
            margin: 0 auto 20px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .profile-picture img {
            width: 60%;
            height: 60%;
            object-fit: contain;
        }

        .info-section {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            color: #555;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
            font-size: 16px;
            box-sizing: border-box;
        }

        input[readonly] {
            background-color: #efefef;
            cursor: not-allowed;
        }

        .email-wrapper {
            position: relative;
        }

        .edit-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #888;
        }

        .logout-link {
            display: block;
            color: #555;
            text-decoration: none;
            margin-top: 20px;
            font-size: 16px;
        }

        .save-button {
            width: 100%;
            padding: 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }

        .save-button:hover {
            background-color: #45a049;
        }

        .alert {
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            display: none;
        }

        .alert.success {
            background-color: #d4edda;
            color: #155724;
            display: block;
        }

        .alert.error {
            background-color: #f8d7da;
            color: #721c24;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/" class="back-arrow">←</a>
            <h1>Profile Settings</h1>
        </div>
        <div class="profile-card">
            <div id="alert" class="alert"></div>
            <div class="profile-picture">
                <img src="static/profile.png" alt="User Avatar">
            </div>
            <div class="info-section">
                <label for="user-id">User ID</label>
                <input type="text" id="user-id" readonly>
            </div>
            <div class="info-section">
                <label for="user-name">Full Name</label>
                <input type="text" id="user-name">
            </div>
            <div class="info-section">
                <label for="email">Email Address</label>
                <div class="email-wrapper">
                    <input type="email" id="email">
                    <span class="edit-icon">✎</span>
                </div>
            </div>
            <div class="info-section">
                <label for="phone">Phone Number</label>
                <input type="tel" id="phone">
            </div>
            <a href="#" id="logout" class="logout-link">Log Out</a>
        </div>
        <button id="save-changes" class="save-button">Save Changes</button>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDvmkf8lWYGhTZFIkoHfyS0rcOGtVSjIj0",
            authDomain: "aimers-62228.firebaseapp.com",
            projectId: "aimers-62228",
            storageBucket: "aimers-62228.firebasestorage.app",
            messagingSenderId: "931266152497",
            appId: "1:931266152497:web:fb1fffedf934f5c79f6d10"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Elements
        const userIdInput = document.getElementById('user-id');
        const userNameInput = document.getElementById('user-name');
        const emailInput = document.getElementById('email');
        const phoneInput = document.getElementById('phone');
        const logoutButton = document.getElementById('logout');
        const saveButton = document.getElementById('save-changes');
        const alertDiv = document.getElementById('alert');

        // Show alert message
        function showAlert(message, type) {
            alertDiv.textContent = message;
            alertDiv.className = `alert ${type}`;
            setTimeout(() => {
                alertDiv.className = 'alert';
            }, 5000);
        }

        // Check for authenticated user
        auth.onAuthStateChanged(user => {
            if (user) {
                const uid = user.uid;
                userIdInput.value = uid;
                emailInput.value = user.email || '';
                
                // Fetch additional user data from Realtime Database
                database.ref('users/' + uid).once('value').then(snapshot => {
                    const userData = snapshot.val();
                    if (userData) {
                        userNameInput.value = userData.name || '';
                        phoneInput.value = userData.phone || '';
                    }
                }).catch(error => {
                    console.error("Error fetching user data:", error);
                    showAlert('Error loading profile data', 'error');
                });

            } else {
                // User is signed out, redirect to login
                console.log("No user is signed in.");
                window.location.href = '/';
            }
        });

        // Logout functionality
        logoutButton.addEventListener('click', (e) => {
            e.preventDefault();
            auth.signOut().then(() => {
                console.log('User signed out successfully.');
                window.location.href = '/';
            }).catch(error => {
                console.error('Sign out error:', error);
                showAlert('Error signing out', 'error');
            });
        });

        // Save changes functionality
        saveButton.addEventListener('click', () => {
            const user = auth.currentUser;
            if (user) {
                const newEmail = emailInput.value;
                const newName = userNameInput.value;
                const newPhone = phoneInput.value;

                // Update email in Firebase Authentication
                user.updateEmail(newEmail).then(() => {
                    // Update profile in Realtime Database
                    database.ref('users/' + user.uid).update({
                        email: newEmail,
                        name: newName,
                        phone: newPhone
                    }).then(() => {
                        showAlert('Profile updated successfully!', 'success');
                    }).catch(error => {
                        console.error('Error updating database:', error);
                        showAlert('Failed to update profile in database', 'error');
                    });
                }).catch(error => {
                    console.error('Error updating email:', error);
                    showAlert(`Failed to update email: ${error.message}`, 'error');
                });
            }
        });
    </script>
</body>
</html>